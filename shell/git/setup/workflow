#!/usr/bin/env bash

set -e

# Fetch repo list
echo "Fetching repo list for NikoboiNFTB..."
repos=$(curl -s "https://api.github.com/users/NikoboiNFTB/repos?per_page=100" | jq -r '.[].name')

if [ -z "$repos" ]; then
    echo "No repositories found (or GitHub API returned none)."
    exit 1
fi

# Create author directory and move to it
mkdir -p "NikoboiNFTB"
cd "NikoboiNFTB" || exit 1

# Clone repos
echo "Cloning using SSH..."
for repo in $repos; do
    if [ -d "$repo/.git" ]; then
        echo "$repo already exists, skipping."
        continue
    fi

    echo "Cloning $repo..."
    if git clone "git@github.com:NikoboiNFTB/$repo.git" >/dev/null 2>&1; then
        echo "Cloned $repo"
    else
        echo "Failed to clone $repo" >&2
    fi
done

# Determine install directories
read -rp "Enter install directory for GitHub-Tools files (Enter for current): " BASE_DIR
BASE_DIR="${BASE_DIR:-$(pwd)}"
PARENT_DIR="$(dirname "$BASE_DIR")"

# Clone GitHub-Tools repository directly
TOOLS_REPO="git@github.com:NikoboiNFTB/GitHub-Tools.git"
TOOLS_DIR="$BASE_DIR/GitHub-Tools-temp"

if [ -d "$TOOLS_DIR" ]; then
    echo "Removing existing $TOOLS_DIR..."
    rm -rf "$TOOLS_DIR"
fi

git clone --depth 1 "$TOOLS_REPO" "$TOOLS_DIR"

# Copy subdirectories
copy_all() {
    local SRC="$1"
    local DEST="$2"
    if [ -d "$SRC" ]; then
        for ITEM in "$SRC"/*; do
            [ -e "$ITEM" ] || continue
            BASENAME=$(basename "$ITEM")
            if [ -d "$ITEM" ]; then
                mkdir -p "$DEST/$BASENAME"
                cp -r "$ITEM/." "$DEST/$BASENAME"
            else
                mkdir -p "$DEST"
                cp "$ITEM" "$DEST/$BASENAME"
            fi
            echo "Copied $ITEM -> $DEST/$BASENAME"
        done
    else
        echo "Warning: $SRC not found"
    fi
}

# Copy directories from GitHub-Tools
copy_all "$TOOLS_DIR/shell/git/bulk" "$BASE_DIR"
copy_all "$TOOLS_DIR/shell/git/repo" "$BASE_DIR"
copy_all "$TOOLS_DIR/shell/git/clone" "$PARENT_DIR"

# Cleanup
rm -rf "$TOOLS_DIR"
echo "Automation setup complete."

# Hang

KEEP_OPEN=true

if [ "$KEEP_OPEN" = true ]; then
    echo
    read -p "Press 'Enter' to exit / Type 'disable' to disable hanging: " response
    if [ "$response" = "disable" ]; then
        sed -i 's/^KEEP_OPEN=true/KEEP_OPEN=false/' "$0"
        echo
        echo "KEEP_OPEN set to false"
        echo "Change 'KEEP_OPEN=true' to enable"
        sleep 4
    fi
fi
